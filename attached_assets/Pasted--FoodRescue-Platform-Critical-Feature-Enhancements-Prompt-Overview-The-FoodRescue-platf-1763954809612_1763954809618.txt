# FoodRescue Platform - Critical Feature Enhancements Prompt

## üéØ Overview
The FoodRescue platform is **ALREADY BUILT AND WORKING**. DO NOT recreate or rebuild the entire application. This prompt is for **ADDING/FIXING SPECIFIC FEATURES ONLY**. Make surgical changes to the existing codebase without breaking current functionality.

---

## ‚ö†Ô∏è CRITICAL INSTRUCTIONS

### DO NOT:
- ‚ùå Recreate any existing components
- ‚ùå Change the current file structure
- ‚ùå Modify working features
- ‚ùå Break existing routes or API endpoints
- ‚ùå Remove or rename existing functions
- ‚ùå Change database schemas that already have data

### DO:
- ‚úÖ Add new features incrementally
- ‚úÖ Extend existing components carefully
- ‚úÖ Test each feature before moving to the next
- ‚úÖ Preserve all current functionality
- ‚úÖ Add new API endpoints without modifying old ones
- ‚úÖ Update models by adding new fields only (never remove existing fields)

---

## üîß Required Enhancements (In Order)

### **ENHANCEMENT 1: Restaurant Rating System in NGO Donation View**

#### Problem:
When NGOs browse donations, they cannot see the donor/restaurant's rating and feedback history to assess reliability.

#### Solution:

**Step 1: Update User Model (Add Rating Fields)**
```javascript
// backend/src/models/User.js
// ADD these fields to the donorProfile section (DO NOT remove existing fields)

donorProfile: {
  // ... existing fields ...
  rating: { 
    type: Number, 
    default: 0,
    min: 0,
    max: 10 
  },
  totalRatings: { 
    type: Number, 
    default: 0 
  },
  ratingBreakdown: {
    foodQuality: { type: Number, default: 0 },
    packaging: { type: Number, default: 0 },
    accuracy: { type: Number, default: 0 },
    communication: { type: Number, default: 0 }
  }
}
```

**Step 2: Create Rating Component for NGO View**
```javascript
// frontend/src/components/ngo/DonorRatingDisplay.jsx
// CREATE THIS NEW FILE

import React from 'react';
import { Star, Award, Package, CheckCircle, MessageCircle } from 'lucide-react';
import { motion } from 'framer-motion';

const DonorRatingDisplay = ({ donor }) => {
  const { rating, totalRatings, ratingBreakdown } = donor.donorProfile;
  
  // Calculate percentage for visual display
  const ratingPercentage = (rating / 10) * 100;
  
  // Star color based on rating
  const getStarColor = (rating) => {
    if (rating >= 8) return 'text-green-500';
    if (rating >= 6) return 'text-yellow-500';
    if (rating >= 4) return 'text-orange-500';
    return 'text-red-500';
  };
  
  return (
    <div className="bg-white rounded-lg p-4 border border-neutral-200">
      {/* Overall Rating */}
      <div className="flex items-center gap-4 mb-4">
        <div className="text-center">
          <div className={`text-4xl font-bold ${getStarColor(rating)}`}>
            {rating.toFixed(1)}
          </div>
          <div className="flex items-center justify-center mt-1">
            {[...Array(5)].map((_, i) => (
              <Star
                key={i}
                className={`w-4 h-4 ${
                  i < Math.round(rating / 2) ? getStarColor(rating) : 'text-neutral-300'
                } ${i < Math.round(rating / 2) ? 'fill-current' : ''}`}
              />
            ))}
          </div>
          <p className="text-xs text-neutral-500 mt-1">
            {totalRatings} {totalRatings === 1 ? 'rating' : 'ratings'}
          </p>
        </div>
        
        {/* Progress Bar */}
        <div className="flex-1">
          <div className="h-3 bg-neutral-100 rounded-full overflow-hidden">
            <motion.div
              className={`h-full ${
                rating >= 8 ? 'bg-green-500' :
                rating >= 6 ? 'bg-yellow-500' :
                rating >= 4 ? 'bg-orange-500' :
                'bg-red-500'
              }`}
              initial={{ width: 0 }}
              animate={{ width: `${ratingPercentage}%` }}
              transition={{ duration: 0.8, ease: 'easeOut' }}
            />
          </div>
          <p className="text-xs text-neutral-500 mt-1">
            {rating >= 8 ? 'Excellent' :
             rating >= 6 ? 'Good' :
             rating >= 4 ? 'Average' :
             'Needs Improvement'}
          </p>
        </div>
      </div>
      
      {/* Rating Breakdown */}
      {totalRatings > 0 && (
        <div className="grid grid-cols-2 gap-3">
          <div className="flex items-center gap-2">
            <Package className="w-4 h-4 text-primary-green" />
            <div className="flex-1">
              <p className="text-xs text-neutral-600">Food Quality</p>
              <p className="text-sm font-semibold">{ratingBreakdown.foodQuality.toFixed(1)}/10</p>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            <Award className="w-4 h-4 text-primary-green" />
            <div className="flex-1">
              <p className="text-xs text-neutral-600">Packaging</p>
              <p className="text-sm font-semibold">{ratingBreakdown.packaging.toFixed(1)}/10</p>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            <CheckCircle className="w-4 h-4 text-primary-green" />
            <div className="flex-1">
              <p className="text-xs text-neutral-600">Accuracy</p>
              <p className="text-sm font-semibold">{ratingBreakdown.accuracy.toFixed(1)}/10</p>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            <MessageCircle className="w-4 h-4 text-primary-green" />
            <div className="flex-1">
              <p className="text-xs text-neutral-600">Communication</p>
              <p className="text-sm font-semibold">{ratingBreakdown.communication.toFixed(1)}/10</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default DonorRatingDisplay;
```

**Step 3: Add Rating Display to Donation Cards**
```javascript
// frontend/src/components/ngo/DonationCard.jsx
// MODIFY existing file - ADD this import and component

import DonorRatingDisplay from './DonorRatingDisplay';

// Inside the DonationCard component, ADD this section after donor info:

<div className="mt-3">
  <DonorRatingDisplay donor={donation.donor} />
</div>
```

**Step 4: Include Donor Info in API Response**
```javascript
// backend/src/controllers/ngoController.js
// MODIFY the browseDonations function

exports.browseDonations = async (req, res) => {
  try {
    // ... existing code ...
    
    const donations = await Donation.find(query)
      .populate({
        path: 'donor',
        select: 'fullName phone donorProfile' // ADD donorProfile
      })
      .sort(sortOption)
      .skip(skip)
      .limit(limit);
    
    // ... rest of existing code ...
  } catch (error) {
    // ... existing error handling ...
  }
};
```

---

### **ENHANCEMENT 2: Real-Time Notification Display System**

#### Problem:
Socket.io is connected but notifications don't appear visually when donations are accepted/matched/status changes.

#### Solution:

**Step 1: Create Notification Bell Component with Visual Feedback**
```javascript
// frontend/src/components/shared/NotificationBell.jsx
// REPLACE/UPDATE existing file completely

import React, { useState, useEffect } from 'react';
import { Bell } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNotifications } from '../../context/NotificationContext';
import NotificationDropdown from './NotificationDropdown';

const NotificationBell = () => {
  const { notifications, unreadCount, markAsRead } = useNotifications();
  const [showDropdown, setShowDropdown] = useState(false);
  const [hasNewNotification, setHasNewNotification] = useState(false);

  // Trigger animation when unread count changes
  useEffect(() => {
    if (unreadCount > 0) {
      setHasNewNotification(true);
      // Play notification sound
      playNotificationSound();
      // Remove animation after 3 seconds
      setTimeout(() => setHasNewNotification(false), 3000);
    }
  }, [unreadCount]);

  const playNotificationSound = () => {
    const audio = new Audio('/notification-sound.mp3');
    audio.volume = 0.5;
    audio.play().catch(err => console.log('Audio play failed:', err));
  };

  return (
    <div className="relative">
      {/* Bell Button */}
      <motion.button
        className="relative p-2 rounded-full hover:bg-neutral-100 transition-colors"
        onClick={() => setShowDropdown(!showDropdown)}
        whileTap={{ scale: 0.95 }}
        animate={hasNewNotification ? { scale: [1, 1.2, 1] } : {}}
        transition={{ duration: 0.3 }}
      >
        <Bell className="w-6 h-6 text-neutral-700" />
        
        {/* Unread Badge */}
        <AnimatePresence>
          {unreadCount > 0 && (
            <motion.span
              className="absolute -top-1 -right-1 bg-red-500 text-white text-xs 
                         rounded-full w-5 h-5 flex items-center justify-center font-bold"
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              exit={{ scale: 0 }}
            >
              {unreadCount > 9 ? '9+' : unreadCount}
            </motion.span>
          )}
        </AnimatePresence>
        
        {/* Pulse Animation */}
        {unreadCount > 0 && (
          <motion.span
            className="absolute -top-1 -right-1 bg-red-500 rounded-full w-5 h-5"
            animate={{ scale: [1, 1.5, 1], opacity: [0.7, 0, 0.7] }}
            transition={{ duration: 2, repeat: Infinity }}
          />
        )}
      </motion.button>

      {/* Dropdown */}
      <AnimatePresence>
        {showDropdown && (
          <NotificationDropdown
            notifications={notifications}
            onClose={() => setShowDropdown(false)}
            onMarkAsRead={markAsRead}
          />
        )}
      </AnimatePresence>
    </div>
  );
};

export default NotificationBell;
```

**Step 2: Create Notification Dropdown**
```javascript
// frontend/src/components/shared/NotificationDropdown.jsx
// CREATE THIS NEW FILE

import React from 'react';
import { motion } from 'framer-motion';
import { X, Check, Package, User, MapPin, Star, AlertCircle } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { useNavigate } from 'react-router-dom';

const NotificationDropdown = ({ notifications, onClose, onMarkAsRead }) => {
  const navigate = useNavigate();

  const getNotificationIcon = (type) => {
    switch (type) {
      case 'donation_matched':
      case 'donation_accepted':
        return <Package className="w-5 h-5 text-primary-green" />;
      case 'volunteer_assigned':
        return <User className="w-5 h-5 text-accent-blue" />;
      case 'status_updated':
        return <MapPin className="w-5 h-5 text-accent-orange" />;
      case 'delivery_completed':
        return <Check className="w-5 h-5 text-green-600" />;
      case 'new_rating':
        return <Star className="w-5 h-5 text-yellow-500" />;
      default:
        return <AlertCircle className="w-5 h-5 text-neutral-500" />;
    }
  };

  const handleNotificationClick = (notification) => {
    // Mark as read
    onMarkAsRead(notification._id);
    
    // Navigate to relevant page
    if (notification.relatedDonation) {
      navigate(`/donations/${notification.relatedDonation}`);
    }
    
    onClose();
  };

  return (
    <motion.div
      className="absolute top-full right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl 
                 border border-neutral-200 z-50 max-h-[600px] overflow-hidden flex flex-col"
      initial={{ opacity: 0, y: -20, scale: 0.95 }}
      animate={{ opacity: 1, y: 0, scale: 1 }}
      exit={{ opacity: 0, y: -20, scale: 0.95 }}
      transition={{ duration: 0.2 }}
    >
      {/* Header */}
      <div className="p-4 border-b border-neutral-200 flex items-center justify-between">
        <h3 className="font-bold text-lg">Notifications</h3>
        <button
          onClick={onClose}
          className="p-1 hover:bg-neutral-100 rounded-full transition-colors"
        >
          <X className="w-5 h-5" />
        </button>
      </div>

      {/* Notifications List */}
      <div className="overflow-y-auto flex-1">
        {notifications.length === 0 ? (
          <div className="p-8 text-center text-neutral-500">
            <Bell className="w-12 h-12 mx-auto mb-3 text-neutral-300" />
            <p>No notifications yet</p>
          </div>
        ) : (
          <div className="divide-y divide-neutral-100">
            {notifications.slice(0, 10).map((notification) => (
              <motion.div
                key={notification._id}
                className={`p-4 hover:bg-neutral-50 cursor-pointer transition-colors ${
                  !notification.isRead ? 'bg-primary-light/30' : ''
                }`}
                onClick={() => handleNotificationClick(notification)}
                whileHover={{ x: 4 }}
              >
                <div className="flex gap-3">
                  {/* Icon */}
                  <div className="flex-shrink-0 mt-1">
                    {getNotificationIcon(notification.type)}
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                    <p className="font-semibold text-sm text-neutral-900 mb-1">
                      {notification.title}
                    </p>
                    <p className="text-sm text-neutral-600 mb-2">
                      {notification.message}
                    </p>
                    <p className="text-xs text-neutral-400">
                      {formatDistanceToNow(new Date(notification.createdAt), { addSuffix: true })}
                    </p>
                  </div>

                  {/* Unread Indicator */}
                  {!notification.isRead && (
                    <div className="flex-shrink-0">
                      <div className="w-2 h-2 bg-red-500 rounded-full mt-2" />
                    </div>
                  )}
                </div>
              </motion.div>
            ))}
          </div>
        )}
      </div>

      {/* Footer */}
      {notifications.length > 0 && (
        <div className="p-3 border-t border-neutral-200 text-center">
          <button
            onClick={() => {
              navigate('/notifications');
              onClose();
            }}
            className="text-sm text-primary-green hover:underline font-medium"
          >
            View All Notifications
          </button>
        </div>
      )}
    </motion.div>
  );
};

export default NotificationDropdown;
```

**Step 3: Update Notification Context to Handle Socket Events**
```javascript
// frontend/src/context/NotificationContext.jsx
// MODIFY existing file - ADD socket integration

import { createContext, useContext, useState, useEffect } from 'react';
import { useAuth } from './AuthContext';
import socketService from '../services/socketService';
import toast from 'react-hot-toast';
import api from '../services/api';

const NotificationContext = createContext();

export const NotificationProvider = ({ children }) => {
  const { user, token } = useAuth();
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);

  // Fetch initial notifications
  useEffect(() => {
    if (user && token) {
      fetchNotifications();
    }
  }, [user, token]);

  // Setup socket listeners
  useEffect(() => {
    if (user && token) {
      // Connect socket
      socketService.connect(token);
      socketService.joinRoom(user._id, user.role);

      // Listen for new notifications
      socketService.on('new_notification', (data) => {
        console.log('üì¨ New notification received:', data);
        
        // Add to notifications list
        setNotifications(prev => [data, ...prev]);
        setUnreadCount(prev => prev + 1);
        
        // Show toast with custom styling
        toast.success(data.message, {
          duration: 5000,
          icon: 'üîî',
          style: {
            borderRadius: '10px',
            background: '#10B981',
            color: '#fff',
          },
        });
      });

      // Listen for donation matched
      socketService.on('donation_matched', (data) => {
        console.log('‚úÖ Donation matched:', data);
        toast.success('New donation matched to your organization!');
      });

      // Listen for donation accepted
      socketService.on('donation_accepted', (data) => {
        console.log('‚úÖ Donation accepted:', data);
        toast.success('Your donation has been accepted!');
      });

      // Listen for volunteer assigned
      socketService.on('volunteer_assigned', (data) => {
        console.log('üöó Volunteer assigned:', data);
        toast.success(`Volunteer ${data.volunteer.name} assigned for pickup!`);
      });

      // Listen for status updates
      socketService.on('status_updated', (data) => {
        console.log('üîÑ Status updated:', data);
        const statusMessages = {
          'picked_up': 'üì¶ Food picked up by volunteer',
          'in_transit': 'üöó Food in transit to NGO',
          'delivered': '‚úÖ Food delivered successfully!',
        };
        if (statusMessages[data.newStatus]) {
          toast.success(statusMessages[data.newStatus]);
        }
      });

      // Listen for delivery completed
      socketService.on('delivery_completed', (data) => {
        console.log('üéâ Delivery completed:', data);
        toast.success('Delivery completed! Please rate the NGO.');
      });

      return () => {
        socketService.disconnect();
      };
    }
  }, [user, token]);

  const fetchNotifications = async () => {
    try {
      const response = await api.get('/notifications?limit=50');
      setNotifications(response.data.notifications);
      setUnreadCount(response.data.unreadCount);
    } catch (error) {
      console.error('Error fetching notifications:', error);
    }
  };

  const markAsRead = async (notificationId) => {
    try {
      await api.put(`/notifications/${notificationId}/read`);
      setNotifications(prev =>
        prev.map(notif =>
          notif._id === notificationId ? { ...notif, isRead: true } : notif
        )
      );
      setUnreadCount(prev => Math.max(0, prev - 1));
    } catch (error) {
      console.error('Error marking notification as read:', error);
    }
  };

  const markAllAsRead = async () => {
    try {
      await api.put('/notifications/mark-all-read');
      setNotifications(prev =>
        prev.map(notif => ({ ...notif, isRead: true }))
      );
      setUnreadCount(0);
    } catch (error) {
      console.error('Error marking all as read:', error);
    }
  };

  return (
    <NotificationContext.Provider
      value={{
        notifications,
        unreadCount,
        markAsRead,
        markAllAsRead,
        refreshNotifications: fetchNotifications
      }}
    >
      {children}
    </NotificationContext.Provider>
  );
};

export const useNotifications = () => {
  const context = useContext(NotificationContext);
  if (!context) {
    throw new Error('useNotifications must be used within NotificationProvider');
  }
  return context;
};
```

---

### **ENHANCEMENT 3: Volunteer Assignment & Live Tracking System**

#### Problem:
When NGO accepts a donation, nearby volunteers aren't notified and there's no live tracking of volunteer location.

#### Solution:

**Step 1: Create Volunteer Assignment Logic**
```javascript
// backend/src/services/volunteerAssignmentService.js
// CREATE THIS NEW FILE

const User = require('../models/User');
const VolunteerTask = require('../models/VolunteerTask');
const Donation = require('../models/Donation');
const notificationService = require('./notificationService');

// Find and assign nearest available volunteer
exports.assignVolunteerToDonation = async (donation) => {
  try {
    console.log(`üîç Finding volunteer for donation ${donation.donationId}`);
    
    const pickupLocation = donation.location.coordinates.coordinates;
    const deliveryLocation = donation.matchedNGO.ngoProfile.address.coordinates.coordinates;
    
    // Find available volunteers within 20km radius
    const availableVolunteers = await User.find({
      role: 'volunteer',
      isVerified: true,
      isActive: true,
      'volunteerProfile.currentLocation': {
        $nearSphere: {
          $geometry: {
            type: 'Point',
            coordinates: pickupLocation
          },
          $maxDistance: 20000 // 20km in meters
        }
      }
    }).limit(10);
    
    if (availableVolunteers.length === 0) {
      console.log('‚ùå No available volunteers found');
      return null;
    }
    
    // Check if volunteer has active tasks
    const volunteersWithoutActiveTasks = [];
    for (const volunteer of availableVolunteers) {
      const activeTasks = await VolunteerTask.countDocuments({
        volunteer: volunteer._id,
        status: { $in: ['assigned', 'accepted', 'picked_up', 'in_transit'] }
      });
      
      if (activeTasks === 0) {
        volunteersWithoutActiveTasks.push(volunteer);
      }
    }
    
    if (volunteersWithoutActiveTasks.length === 0) {
      console.log('‚ùå All nearby volunteers are busy');
      return null;
    }
    
    // Select the closest available volunteer
    const selectedVolunteer = volunteersWithoutActiveTasks[0];
    
    // Calculate distance and estimated time
    const distance = calculateDistance(pickupLocation, selectedVolunteer.volunteerProfile.currentLocation.coordinates);
    const estimatedTime = Math.ceil(distance / 0.5); // Assuming 30 km/h average speed
    
    // Create volunteer task
    const task = await VolunteerTask.create({
      taskId: `VT-${Date.now()}`,
      donation: donation._id,
      volunteer: selectedVolunteer._id,
      donor: donation.donor,
      ngo: donation.matchedNGO._id,
      pickupLocation: {
        name: donation.donor.donorProfile.businessName,
        address: donation.location.address,
        coordinates: {
          type: 'Point',
          coordinates: pickupLocation
        },
        contactPhone: donation.donor.phone
      },
      deliveryLocation: {
        name: donation.matchedNGO.ngoProfile.organizationName,
        address: donation.matchedNGO.ngoProfile.address,
        coordinates: {
          type: 'Point',
          coordinates: deliveryLocation
        },
        contactPhone: donation.matchedNGO.phone
      },
      distance,
      estimatedTime,
      status: 'assigned',
      timeline: [{
        status: 'assigned',
        timestamp: new Date(),
        note: `Assigned to ${selectedVolunteer.fullName}`
      }]
    });
    
    // Update donation
    donation.assignedVolunteer = selectedVolunteer._id;
    donation.assignedAt = new Date();
    donation.timeline.push({
      status: 'volunteer_assigned',
      timestamp: new Date(),
      updatedBy: selectedVolunteer._id,
      note: `Volunteer ${selectedVolunteer.fullName} assigned`
    });
    await donation.save();
    
    // Send notifications to all parties
    await notificationService.createNotification({
      recipient: selectedVolunteer._id,
      type: 'volunteer_assigned',
      title: 'New Delivery Task Assigned!',
      message: `You have been assigned to pick up food from ${donation.donor.donorProfile.businessName}`,
      relatedDonation: donation._id,
      relatedTask: task._id,
      priority: 'high'
    });
    
    await notificationService.createNotification({
      recipient: donation.donor,
      type: 'volunteer_assigned',
      title: 'Volunteer Assigned',
      message: `${selectedVolunteer.fullName} will pick up your donation soon`,
      relatedDonation: donation._id,
      priority: 'medium'
    });
    
    await notificationService.createNotification({
      recipient: donation.matchedNGO._id,
      type: 'volunteer_assigned',
      title: 'Volunteer On The Way',
      message: `${selectedVolunteer.fullName} is coming to deliver the food`,
      relatedDonation: donation._id,
      priority: 'medium'
    });
    
    // Emit socket events
    global.io.to(selectedVolunteer._id.toString()).emit('volunteer_assigned', {
      taskId: task._id,
      donation: donation,
      estimatedTime,
      distance
    });
    
    global.io.to(donation.donor.toString()).emit('volunteer_assigned', {
      donationId: donation._id,
      volunteer: {
        id: selectedVolunteer._id,
        name: selectedVolunteer.fullName,
        phone: selectedVolunteer.phone
      },
      eta: estimatedTime
    });
    
    global.io.to(donation.matchedNGO._id.toString()).emit('volunteer_assigned', {
      donationId: donation._id,
      volunteer: {
        id: selectedVolunteer._id,
        name: selectedVolunteer.fullName,
        phone: selectedVolunteer.phone
      },
      eta: estimatedTime
    });
    
    console.log(`‚úÖ Volunteer ${selectedVolunteer.fullName} assigned to donation ${donation.donationId}`);
    
    return task;
  } catch (error) {
    console.error('Error assigning volunteer:', error);
    return null;
  }
};

// Haversine formula for distance calculation
function calculateDistance(coord1, coord2) {
  const [lon1, lat1] = coord1;
  const [lon2, lat2] = coord2;
  
  const R = 6371; // Earth's radius in km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c;
  
  return distance;
}

function toRad(degrees) {
  return degrees * (Math.PI / 180);
}

module.exports = exports;
```

**Step 2: Trigger Volunteer Assignment When NGO Accepts**
```javascript
// backend/src/controllers/ngoController.js
// MODIFY the acceptDonation function

const volunteerAssignmentService = require('../services/volunteerAssignmentService');

exports.acceptDonation = async (req, res) => {
  try {
    const { id } = req.params;
    
    const donation = await Donation.findById(id)
      .populate('donor matchedNGO');
    
    if (!donation) {
      return res.status(404).json({ success: false, message: 'Donation not found' });
    }
    
    // ... existing validation code ...
    
    // Update donation status
    donation.status = 'accepted';
    donation.acceptedAt = new Date();
    donation.timeline.push({
      status: 'accepted',
      timestamp: new Date(),
      updatedBy: req.user._id,
      note: 'Donation accepted by NGO'
    });
    await donation.save();
    
    // NOTIFY DONOR
    await notificationService.createNotification({
      recipient: donation.donor._id,
      type: 'donation_accepted',
      title: 'Donation Accepted!',
      message: `${req.user.ngoProfile.organizationName} has accepted your donation`,
      relatedDonation: donation._id
    });
    
    global.io.to(donation.donor._id.toString()).emit('donation_accepted', {
      donationId: donation._id,
      ngo: {
        id: req.user._id,
        name: req.user.ngoProfile.organizationName
      },
      timestamp: new Date()
    });
    
    // **NEW: ASSIGN VOLUNTEER AUTOMATICALLY**
    setTimeout(async () => {
      const task = await volunteerAssignmentService.assignVolunteerToDonation(donation);
      if (!task) {
        console.log('‚ö†Ô∏è Could not assign volunteer automatically');
      }
    }, 2000); // Wait 2 seconds before assigning
    
    res.json({
      success: true,
      message: 'Donation accepted successfully',
      donation
    });
  } catch (error) {
    console.error('Accept donation error:', error);
    res.status(500).json({ success: false, message: 'Server error' });
  }
};
```