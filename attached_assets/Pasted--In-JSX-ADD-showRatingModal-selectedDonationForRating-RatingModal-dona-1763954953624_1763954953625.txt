]);

// In JSX, ADD:
{showRatingModal && selectedDonationForRating && (
  <RatingModal
    donation={selectedDonationForRating}
    ngo={selectedDonationForRating.matchedNGO}
    onClose={() => {
      setShowRatingModal(false);
      setSelectedDonationForRating(null);
    }}
    onSubmit={() => {
      // Refresh donations to update rated status
      fetchDonations();
    }}
  />
)}
```

**Step 3: Update Backend to Calculate and Store Ratings**
```javascript
// backend/src/controllers/donorController.js
// ADD or UPDATE the ratings endpoint

exports.rateDonation = async (req, res) => {
  try {
    const { donation, ngo, rating, comment, categories } = req.body;

    // Validate
    if (!donation || !ngo || !rating) {
      return res.status(400).json({
        success: false,
        message: 'Donation, NGO, and rating are required'
      });
    }

    if (rating < 1 || rating > 10) {
      return res.status(400).json({
        success: false,
        message: 'Rating must be between 1 and 10'
      });
    }

    // Check if donation exists and belongs to user
    const donationDoc = await Donation.findOne({
      _id: donation,
      donor: req.user._id,
      status: 'delivered'
    });

    if (!donationDoc) {
      return res.status(404).json({
        success: false,
        message: 'Donation not found or not yet delivered'
      });
    }

    // Check if already rated
    const existingRating = await Rating.findOne({
      donation,
      ratedBy: req.user._id
    });

    if (existingRating) {
      return res.status(400).json({
        success: false,
        message: 'You have already rated this donation'
      });
    }

    // Create rating
    const newRating = await Rating.create({
      donation,
      ratedBy: req.user._id,
      ratedTo: ngo,
      ratedType: 'ngo',
      rating,
      comment,
      categories
    });

    // Update NGO rating
    const ngoUser = await User.findById(ngo);
    const currentRating = ngoUser.ngoProfile.rating || 0;
    const currentTotal = ngoUser.ngoProfile.totalRatings || 0;
    
    const newTotal = currentTotal + 1;
    const newAverage = ((currentRating * currentTotal) + rating) / newTotal;
    
    // Update rating breakdown
    const currentBreakdown = ngoUser.ngoProfile.ratingBreakdown || {
      foodQuality: 0,
      packaging: 0,
      accuracy: 0,
      communication: 0
    };
    
    ngoUser.ngoProfile.rating = newAverage;
    ngoUser.ngoProfile.totalRatings = newTotal;
    ngoUser.ngoProfile.ratingBreakdown = {
      foodQuality: ((currentBreakdown.foodQuality * currentTotal) + categories.foodQuality) / newTotal,
      packaging: ((currentBreakdown.packaging * currentTotal) + categories.packaging) / newTotal,
      accuracy: ((currentBreakdown.accuracy * currentTotal) + categories.accuracy) / newTotal,
      communication: ((currentBreakdown.communication * currentTotal) + categories.communication) / newTotal
    };
    
    await ngoUser.save();

    // Mark donation as rated
    donationDoc.rated = true;
    await donationDoc.save();

    // Send notification to NGO
    await notificationService.createNotification({
      recipient: ngo,
      type: 'new_rating',
      title: 'New Rating Received',
      message: `You received a ${rating}/10 rating from ${req.user.donorProfile.businessName}`,
      relatedDonation: donation
    });

    global.io.to(ngo.toString()).emit('new_notification', {
      type: 'new_rating',
      message: `New rating: ${rating}/10`,
      donation: donationDoc
    });

    res.json({
      success: true,
      message: 'Rating submitted successfully',
      rating: newRating
    });
  } catch (error) {
    console.error('Rate donation error:', error);
    res.status(500).json({ success: false, message: 'Server error' });
  }
};
```

---

### **ENHANCEMENT 6: Real-Time Urgency Score Calculation**

#### Problem:
Urgency score doesn't calculate in real-time as user fills the donation form.

#### Solution:

```javascript
// frontend/src/components/donor/DonationUploadForm.jsx
// ADD this logic to existing form

import { useEffect } from 'react';
import { AlertCircle, Clock, TrendingUp } from 'lucide-react';

// Inside component, ADD:
const [urgencyData, setUrgencyData] = useState({
  score: 0,
  category: 'low',
  shelfLifeHours: 0
});

// Calculate urgency whenever relevant fields change
useEffect(() => {
  const category = watch('category');
  const preparationTime = watch('preparationTime');
  const expiryTime = watch('expiryTime');
  
  if (category && preparationTime && expiryTime) {
    calculateUrgency(category, new Date(preparationTime), new Date(expiryTime));
  }
}, [watch('category'), watch('preparationTime'), watch('expiryTime')]);

const calculateUrgency = (category, prepTime, expTime) => {
  // Calculate shelf life in hours
  const now = new Date();
  const shelfLifeMs = expTime - now;
  const shelfLifeHours = Math.max(0, shelfLifeMs / (1000 * 60 * 60));
  
  // Perishability scores
  const perishabilityScores = {
    'cooked_meals': 0.9,
    'dairy': 0.8,
    'bakery': 0.6,
    'vegetables': 0.5,
    'fruits': 0.5,
    'packaged_food': 0.2,
    'beverages': 0.3,
    'other': 0.5
  };
  
  const perishability = perishabilityScores[category] || 0.5;
  
  // Time urgency
  let timeUrgency;
  if (shelfLifeHours < 2) {
    timeUrgency = 1.0; // Critical
  } else if (shelfLifeHours < 4) {
    timeUrgency = 0.8; // High
  } else if (shelfLifeHours < 6) {
    timeUrgency = 0.6; // Medium-high
  } else if (shelfLifeHours < 12) {
    timeUrgency = 0.4; // Medium
  } else if (shelfLifeHours < 24) {
    timeUrgency = 0.2; // Low
  } else {
    timeUrgency = 0.1; // Very low
  }
  
  // Calculate overall score
  const score = (perishability * 0.6) + (timeUrgency * 0.4);
  
  // Determine category
  let urgencyCategory;
  if (score >= 0.7) {
    urgencyCategory = 'high';
  } else if (score >= 0.4) {
    urgencyCategory = 'medium';
  } else {
    urgencyCategory = 'low';
  }
  
  setUrgencyData({
    score: (score * 10).toFixed(1), // Convert to 0-10 scale
    category: urgencyCategory,
    shelfLifeHours: shelfLifeHours.toFixed(1)
  });
};

const getUrgencyColor = (category) => {
  switch (category) {
    case 'high':
      return 'from-red-500 to-red-600';
    case 'medium':
      return 'from-orange-500 to-orange-600';
    case 'low':
      return 'from-green-500 to-green-600';
    default:
      return 'from-neutral-400 to-neutral-500';
  }
};

const getUrgencyText = (category) => {
  switch (category) {
    case 'high':
      return 'High Urgency - Needs immediate attention!';
    case 'medium':
      return 'Medium Urgency - Should be handled soon';
    case 'low':
      return 'Low Urgency - Can wait';
    default:
      return 'Fill all fields to calculate urgency';
  }
};

// ADD this at the bottom of the form (before submit button):

{urgencyData.score > 0 && (
  <motion.div
    className={`bg-gradient-to-r ${getUrgencyColor(urgencyData.category)} rounded-xl p-6 text-white`}
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    key={urgencyData.score}
  >
    <div className="flex items-center justify-between mb-4">
      <div>
        <h3 className="text-lg font-bold mb-1">Urgency Score</h3>
        <p className="text-white/90 text-sm">{getUrgencyText(urgencyData.category)}</p>
      </div>
      <motion.div
        className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm"
        animate={{ scale: urgencyData.category === 'high' ? [1, 1.1, 1] : 1 }}
        transition={{ duration: 1, repeat: urgencyData.category === 'high' ? Infinity : 0 }}
      >
        <span className="text-3xl font-bold">{urgencyData.score}</span>
      </motion.div>
    </div>
    
    <div className="grid grid-cols-3 gap-4">
      <div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
        <Clock className="w-5 h-5 mb-1" />
        <p className="text-xs opacity-90">Shelf Life</p>
        <p className="font-bold">{urgencyData.shelfLifeHours}hrs</p>
      </div>
      
      <div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
        <TrendingUp className="w-5 h-5 mb-1" />
        <p className="text-xs opacity-90">Priority</p>
        <p className="font-bold capitalize">{urgencyData.category}</p>
      </div>
      
      <div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
        <AlertCircle className="w-5 h-5 mb-1" />
        <p className="text-xs opacity-90">Action</p>
        <p className="font-bold text-xs">
          {urgencyData.category === 'high' ? 'Urgent' :
           urgencyData.category === 'medium' ? 'Soon' :
           'Normal'}
        </p>
      </div>
    </div>
  </motion.div>
)}
```

---

### **ENHANCEMENT 7: Consistency & Polish**

#### Final Touches:

**Step 1: Ensure All Status Updates Emit Socket Events**
```javascript
// backend/src/controllers/volunteerController.js
// UPDATE the updateTaskStatus function

exports.updateTaskStatus = async (req, res) => {
  try {
    const { id } = req.params;
    const { status, note, photo, location } = req.body;

    const task = await VolunteerTask.findOne({
      _id: id,
      volunteer: req.user._id
    }).populate('donation donor ngo');

    if (!task) {
      return res.status(404).json({ success: false, message: 'Task not found' });
    }

    // Update task status
    task.status = status;
    if (photo) task.photos.deliveryPhoto = photo;
    
    task.timeline.push({
      status,
      timestamp: new Date(),
      location: location ? { coordinates: location } : undefined,
      note
    });

    // Update corresponding donation status
    const donation = task.donation;
    
    if (status === 'picked_up') {
      donation.status = 'picked_up';
      donation.pickupTime = new Date();
      task.pickupTime = new Date();
    } else if (status === 'in_transit') {
      donation.status = 'in_transit';
    } else if (status === 'delivered') {
      donation.status = 'delivered';
      donation.deliveryTime = new Date();
      task.deliveryTime = new Date();
      task.actualTime = Math.ceil((task.deliveryTime - task.createdAt) / 60000); // in minutes
    }
    
    donation.timeline.push({
      status,
      timestamp: new Date(),
      updatedBy: req.user._id,
      note
    });

    await task.save();
    await donation.save();

    // CREATE NOTIFICATIONS FOR ALL PARTIES
    const statusMessages = {
      'picked_up': 'Food picked up',
      'in_transit': 'Food in transit',
      'delivered': 'Food delivered'
    };

    // Notify donor
    await notificationService.createNotification({
      recipient: donation.donor._id,
      type: 'status_updated',
      title: 'Delivery Update',
      message: `${statusMessages[status]} by ${req.user.fullName}`,
      relatedDonation: donation._id
    });

    // Notify NGO
    await notificationService.createNotification({
      recipient: donation.matchedNGO._id,
      type: 'status_updated',
      title: 'Delivery Update',
      message: `${statusMessages[status]} - ETA: ${task.estimatedTime} minutes`,
      relatedDonation: donation._id
    });

    // EMIT SOCKET EVENTS TO ALL PARTIES
    global.io.to(donation.donor._id.toString()).emit('status_updated', {
      donationId: donation._id,
      newStatus: status,
      timestamp: new Date(),
      volunteer: {
        name: req.user.fullName,
        phone: req.user.phone
      }
    });

    global.io.to(donation.matchedNGO._id.toString()).emit('status_updated', {
      donationId: donation._id,
      newStatus: status,
      timestamp: new Date(),
      volunteer: {
        name: req.user.fullName,
        phone: req.user.phone
      }
    });

    // If delivered, emit special event
    if (status === 'delivered') {
      global.io.to(donation.donor._id.toString()).emit('delivery_completed', {
        donationId: donation._id,
        taskId: task._id,
        timestamp: new Date()
      });
    }

    res.json({
      success: true,
      message: 'Task status updated',
      task,
      donation
    });
  } catch (error) {
    console.error('Update task status error:', error);
    res.status(500).json({ success: false, message: 'Server error' });
  }
};
```

**Step 2: Add Notification Sound File**
```javascript
// frontend/public/notification-sound.mp3
// ADD a notification sound file to the public folder
// You can use a free sound from: https://notificationsounds.com/
// Or create a simple beep sound
```

**Step 3: Update Dashboard Stats to Include Ratings**
```javascript
// frontend/src/pages/DonorDashboard.jsx
// UPDATE stats cards to include rating info

<StatsCard
  icon={Star}
  label="Your Rating"
  value={donorRating.toFixed(1)}
  unit="/10"
  change={`Based on ${totalRatings} ratings`}
  color="yellow"
/>
```

---

## ðŸŽ¯ Implementation Checklist

### Before You Start:
- [ ] Backup your entire project
- [ ] Create a new git branch: `git checkout -b enhancements`
- [ ] Make sure your current code is working

### Implementation Order (DO NOT SKIP):

1. **Enhancement 1: Restaurant Rating System** (30 mins)
   - [ ] Update User model with rating fields
   - [ ] Create DonorRatingDisplay component
   - [ ] Add to NGO donation cards
   - [ ] Update API to include donor info
   - [ ] Test: Browse donations as NGO, verify ratings show

2. **Enhancement 2: Notification System** (45 mins)
   - [ ] Update NotificationBell component
   - [ ] Create NotificationDropdown component
   - [ ] Update NotificationContext with socket listeners
   - [ ] Add notification sound
   - [ ] Test: Accept donation, verify notification appears with sound

3. **Enhancement 3: Volunteer Assignment & Tracking** (60 mins)
   - [ ] Create volunteerAssignmentService
   - [ ] Update acceptDonation to trigger assignment
   - [ ] Create LiveTrackingMap component
   - [ ] Add to NGO dashboard
   - [ ] Test: Accept donation, verify volunteer assigned, map shows

4. **Enhancement 4: Mark as Delivered** (30 mins)
   - [ ] Create DeliveryConfirmationModal
   - [ ] Add button to volunteer dashboard
   - [ ] Update backend controller
   - [ ] Test: Mark delivery, verify photo upload works

5. **Enhancement 5: Rating System** (45 mins)
   - [ ] Create RatingModal component
   - [ ] Add to donor dashboard
   - [ ] Implement backend rating endpoint
   - [ ] Test: Complete delivery, rate NGO, verify score updates

6. **Enhancement 6: Urgency Calculator** (20 mins)
   - [ ] Add real-time calculation to upload form
   - [ ] Create urgency display card
   - [ ] Test: Fill form, verify score updates live

7. **Enhancement 7: Consistency** (30 mins)
   - [ ] Update all socket emissions
   - [ ] Add notification sound
   - [ ] Update dashboard stats
   - [ ] Test: Complete full flow from upload to delivery

### After Implementation:
- [ ] Test complete user flow: Donor â†’ NGO â†’ Volunteer â†’ Rating
- [ ] Verify all notifications appear
- [ ] Check live tracking works
- [ ] Confirm ratings update correctly
- [ ] Test on mobile responsive view
- [ ] Check console for errors
- [ ] Commit changes: `git commit -m "Add enhancements"`

---

## ðŸš¨ IMPORTANT REMINDERS

1. **DO NOT delete or rename existing code** - Only add new code
2. **Test each enhancement individually** before moving to the next
3. **If something breaks**, revert that specific file and try again
4. **Keep your backend running** while testing
5. **Clear browser cache** if components don't update
6. **Check browser console** for errors after each change
7. **Verify socket connection** in Network tab (should show WS connection)

---

## âœ… Success Criteria

Your enhancements are complete when:
- âœ… Restaurants have ratings visible in NGO view
- âœ… Notifications appear with sound when events happen
- âœ… Volunteers are auto-assigned when NGO accepts
- âœ… Live map tracking shows volunteer location
- âœ… Volunteers can mark as delivered with photo
- âœ… Rating modal appears after delivery
- âœ… Ratings update donor dashboard
- âœ… Urgency score calculates in real-time during upload
- âœ… All features work without breaking existing functionality

---

**Good luck with your enhancements! Make changes carefully and test thoroughly! ðŸš€**