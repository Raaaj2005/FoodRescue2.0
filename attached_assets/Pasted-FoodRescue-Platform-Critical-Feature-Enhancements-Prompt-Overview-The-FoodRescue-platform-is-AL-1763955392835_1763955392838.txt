FoodRescue Platform - Critical Feature Enhancements Prompt
ðŸŽ¯ Overview
The FoodRescue platform is ALREADY BUILT AND WORKING. DO NOT recreate or rebuild the entire application. This prompt is for ADDING/FIXING SPECIFIC FEATURES ONLY. Make surgical changes to the existing codebase without breaking current functionality.


âš ï¸ CRITICAL INSTRUCTIONS
DO NOT:
âŒ Recreate any existing components
âŒ Change the current file structure
âŒ Modify working features
âŒ Break existing routes or API endpoints
âŒ Remove or rename existing functions
âŒ Change database schemas that already have data
DO:
âœ… Add new features incrementally
âœ… Extend existing components carefully
âœ… Test each feature before moving to the next
âœ… Preserve all current functionality
âœ… Add new API endpoints without modifying old ones
âœ… Update models by adding new fields only (never remove existing fields)

ðŸ”§ Required Enhancements (In Order)
ENHANCEMENT 1: Restaurant Rating System in NGO Donation View
Problem:
When NGOs browse donations, they cannot see the donor/restaurant's rating and feedback history to assess reliability.

Solution:
Step 1: Update User Model (Add Rating Fields)

// backend/src/models/User.js
// ADD these fields to the donorProfile section (DO NOT remove existing fields)

donorProfile: {
// ... existing fields ...
rating: {
type: Number,
default: 0,
min: 0,
max: 10
},
totalRatings: {
type: Number,
default: 0
},
ratingBreakdown: {
foodQuality: { type: Number, default: 0 },
packaging: { type: Number, default: 0 },
accuracy: { type: Number, default: 0 },
communication: { type: Number, default: 0 }
}
}

Step 2: Create Rating Component for NGO View

// frontend/src/components/ngo/DonorRatingDisplay.jsx
// CREATE THIS NEW FILE

import React from 'react';
import { Star, Award, Package, CheckCircle, MessageCircle } from 'lucide-react';
import { motion } from 'framer-motion';

const DonorRatingDisplay = ({ donor }) => {
const { rating, totalRatings, ratingBreakdown } = donor.donorProfile;

// Calculate percentage for visual display
const ratingPercentage = (rating / 10) * 100;

// Star color based on rating
const getStarColor = (rating) => {
if (rating >= 8) return 'text-green-500';
if (rating >= 6) return 'text-yellow-500';
if (rating >= 4) return 'text-orange-500';
return 'text-red-500';
};

return (
<div className="bg-white rounded-lg p-4 border border-neutral-200">
{/* Overall Rating */}
<div className="flex items-center gap-4 mb-4">
<div className="text-center">
<div className={`text-4xl font-bold ${getStarColor(rating)}`}>
{rating.toFixed(1)}
</div>
<div className="flex items-center justify-center mt-1">
{[...Array(5)].map((_, i) => (
<Star
key={i}
className={`w-4 h-4 ${
i < Math.round(rating / 2) ? getStarColor(rating) : 'text-neutral-300'
} ${i < Math.round(rating / 2) ? 'fill-current' : ''}`}
/>
))}
</div>
<p className="text-xs text-neutral-500 mt-1">
{totalRatings} {totalRatings === 1 ? 'rating' : 'ratings'}
</p>
</div>

{/* Progress Bar */}
<div className="flex-1">
<div className="h-3 bg-neutral-100 rounded-full overflow-hidden">
<motion.div
className={`h-full ${
rating >= 8 ? 'bg-green-500' :
rating >= 6 ? 'bg-yellow-500' :
rating >= 4 ? 'bg-orange-500' :
'bg-red-500'
}`}
initial={{ width: 0 }}
animate={{ width: `${ratingPercentage}%` }}
transition={{ duration: 0.8, ease: 'easeOut' }}
/>
</div>
<p className="text-xs text-neutral-500 mt-1">
{rating >= 8 ? 'Excellent' :
rating >= 6 ? 'Good' :
rating >= 4 ? 'Average' :
'Needs Improvement'}
</p>
</div>
</div>

{/* Rating Breakdown */}
{totalRatings > 0 && (
<div className="grid grid-cols-2 gap-3">
<div className="flex items-center gap-2">
<Package className="w-4 h-4 text-primary-green" />
<div className="flex-1">
<p className="text-xs text-neutral-600">Food Quality</p>
<p className="text-sm font-semibold">{ratingBreakdown.foodQuality.toFixed(1)}/10</p>
</div>
</div>

<div className="flex items-center gap-2">
<Award className="w-4 h-4 text-primary-green" />
<div className="flex-1">
<p className="text-xs text-neutral-600">Packaging</p>
<p className="text-sm font-semibold">{ratingBreakdown.packaging.toFixed(1)}/10</p>
</div>
</div>

<div className="flex items-center gap-2">
<CheckCircle className="w-4 h-4 text-primary-green" />
<div className="flex-1">
<p className="text-xs text-neutral-600">Accuracy</p>
<p className="text-sm font-semibold">{ratingBreakdown.accuracy.toFixed(1)}/10</p>
</div>
</div>

<div className="flex items-center gap-2">
<MessageCircle className="w-4 h-4 text-primary-green" />
<div className="flex-1">
<p className="text-xs text-neutral-600">Communication</p>
<p className="text-sm font-semibold">{ratingBreakdown.communication.toFixed(1)}/10</p>
</div>
</div>
</div>
)}
</div>
);
};

export default DonorRatingDisplay;

Step 3: Add Rating Display to Donation Cards

// frontend/src/components/ngo/DonationCard.jsx
// MODIFY existing file - ADD this import and component

import DonorRatingDisplay from './DonorRatingDisplay';

// Inside the DonationCard component, ADD this section after donor info:

<div className="mt-3">
<DonorRatingDisplay donor={donation.donor} />
</div>

Step 4: Include Donor Info in API Response

// backend/src/controllers/ngoController.js
// MODIFY the browseDonations function

exports.browseDonations = async (req, res) => {
try {
// ... existing code ...

const donations = await Donation.find(query)
.populate({
path: 'donor',
select: 'fullName phone donorProfile' // ADD donorProfile
})
.sort(sortOption)
.skip(skip)
.limit(limit);

// ... rest of existing code ...
} catch (error) {
// ... existing error handling ...
}
};


ENHANCEMENT 2: Real-Time Notification Display System
Problem:
Socket.io is connected but notifications don't appear visually when donations are accepted/matched/status changes.

Solution:
Step 1: Create Notification Bell Component with Visual Feedback

// frontend/src/components/shared/NotificationBell.jsx
// REPLACE/UPDATE existing file completely

import React, { useState, useEffect } from 'react';
import { Bell } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNotifications } from '../../context/NotificationContext';
import NotificationDropdown from './NotificationDropdown';

const NotificationBell = () => {
const { notifications, unreadCount, markAsRead } = useNotifications();
const [showDropdown, setShowDropdown] = useState(false);
const [hasNewNotification, setHasNewNotification] = useState(false);

// Trigger animation when unread count changes
useEffect(() => {
if (unreadCount > 0) {
setHasNewNotification(true);
// Play notification sound
playNotificationSound();
// Remove animation after 3 seconds
setTimeout(() => setHasNewNotification(false), 3000);
}
}, [unreadCount]);

const playNotificationSound = () => {
const audio = new Audio('/notification-sound.mp3');
audio.volume = 0.5;
audio.play().catch(err => console.log('Audio play failed:', err));
};

return (
<div className="relative">
{/* Bell Button */}
<motion.button
className="relative p-2 rounded-full hover:bg-neutral-100 transition-colors"
onClick={() => setShowDropdown(!showDropdown)}
whileTap={{ scale: 0.95 }}
animate={hasNewNotification ? { scale: [1, 1.2, 1] } : {}}
transition={{ duration: 0.3 }}
>
<Bell className="w-6 h-6 text-neutral-700" />

{/* Unread Badge */}
<AnimatePresence>
{unreadCount > 0 && (
<motion.span
className="absolute -top-1 -right-1 bg-red-500 text-white text-xs
rounded-full w-5 h-5 flex items-center justify-center font-bold"
initial={{ scale: 0 }}
animate={{ scale: 1 }}
exit={{ scale: 0 }}
>
{unreadCount > 9 ? '9+' : unreadCount}
</motion.span>
)}
</AnimatePresence>

{/* Pulse Animation */}
{unreadCount > 0 && (
<motion.span
className="absolute -top-1 -right-1 bg-red-500 rounded-full w-5 h-5"
animate={{ scale: [1, 1.5, 1], opacity: [0.7, 0, 0.7] }}
transition={{ duration: 2, repeat: Infinity }}
/>
)}
</motion.button>

{/* Dropdown */}
<AnimatePresence>
{showDropdown && (
<NotificationDropdown
notifications={notifications}
onClose={() => setShowDropdown(false)}
onMarkAsRead={markAsRead}
/>
)}
</AnimatePresence>
</div>
);
};

export default NotificationBell;

Step 2: Create Notification Dropdown

// frontend/src/components/shared/NotificationDropdown.jsx
// CREATE THIS NEW FILE

import React from 'react';
import { motion } from 'framer-motion';
import { X, Check, Package, User, MapPin, Star, AlertCircle } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { useNavigate } from 'react-router-dom';

const NotificationDropdown = ({ notifications, onClose, onMarkAsRead }) => {
const navigate = useNavigate();

const getNotificationIcon = (type) => {
switch (type) {
case 'donation_matched':
case 'donation_accepted':
return <Package className="w-5 h-5 text-primary-green" />;
case 'volunteer_assigned':
return <User className="w-5 h-5 text-accent-blue" />;
case 'status_updated':
return <MapPin className="w-5 h-5 text-accent-orange" />;
case 'delivery_completed':
return <Check className="w-5 h-5 text-green-600" />;
case 'new_rating':
return <Star className="w-5 h-5 text-yellow-500" />;
default:
return <AlertCircle className="w-5 h-5 text-neutral-500" />;
}
};

const handleNotificationClick = (notification) => {
// Mark as read
onMarkAsRead(notification._id);

// Navigate to relevant page
if (notification.relatedDonation) {
navigate(`/donations/${notification.relatedDonation}`);
}

onClose();
};

return (
<motion.div
className="absolute top-full right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl
border border-neutral-200 z-50 max-h-[600px] overflow-hidden flex flex-col"
initial={{ opacity: 0, y: -20, scale: 0.95 }}
animate={{ opacity: 1, y: 0, scale: 1 }}
exit={{ opacity: 0, y: -20, scale: 0.95 }}
transition={{ duration: 0.2 }}
>
{/* Header */}
<div className="p-4 border-b border-neutral-200 flex items-center justify-between">
<h3 className="font-bold text-lg">Notifications</h3>
<button
onClick={onClose}
className="p-1 hover:bg-neutral-100 rounded-full transition-colors"
>
<X className="w-5 h-5" />
</button>
</div>

{/* Notifications List */}
<div className="overflow-y-auto flex-1">
{notifications.length === 0 ? (
<div className="p-8 text-center text-neutral-500">
<Bell className="w-12 h-12 mx-auto mb-3 text-neutral-300" />
<p>No notifications yet</p>
</div>
) : (
<div className="divide-y divide-neutral-100">
{notifications.slice(0, 10).map((notification) => (
<motion.div
key={notification._id}
className={`p-4 hover:bg-neutral-50 cursor-pointer transition-colors ${
!notification.isRead ? 'bg-primary-light/30' : ''
}`}
onClick={() => handleNotificationClick(notification)}
whileHover={{ x: 4 }}
>
<div className="flex gap-3">
{/* Icon */}
<div className="flex-shrink-0 mt-1">
{getNotificationIcon(notification.type)}
</div>

{/* Content */}
<div className="flex-1 min-w-0">
<p className="font-semibold text-sm text-neutral-900 mb-1">
{notification.title}
</p>
<p className="text-sm text-neutral-600 mb-2">
{notification.message}
</p>
<p className="text-xs text-neutral-400">
{formatDistanceToNow(new Date(notification.createdAt), { addSuffix: true })}
</p>
</div>

{/* Unread Indicator */}
{!notification.isRead && (
<div className="flex-shrink-0">
<div className="w-2 h-2 bg-red-500 rounded-full mt-2" />
</div>
)}
</div>
</motion.div>
))}
</div>
)}
</div>

{/* Footer */}
{notifications.length > 0 && (
<div className="p-3 border-t border-neutral-200 text-center">
<button
onClick={() => {
navigate('/notifications');
onClose();
}}
className="text-sm text-primary-green hover:underline font-medium"
>
View All Notifications
</button>
</div>
)}
</motion.div>
);
};

export default NotificationDropdown;

Step 3: Update Notification Context to Handle Socket Events

// frontend/src/context/NotificationContext.jsx
// MODIFY existing file - ADD socket integration

import { createContext, useContext, useState, useEffect } from 'react';
import { useAuth } from './AuthContext';
import socketService from '../services/socketService';
import toast from 'react-hot-toast';
import api from '../services/api';

const NotificationContext = createContext();

export const NotificationProvider = ({ children }) => {
const { user, token } = useAuth();
const [notifications, setNotifications] = useState([]);
const [unreadCount, setUnreadCount] = useState(0);

// Fetch initial notifications
useEffect(() => {
if (user && token) {
fetchNotifications();
}
}, [user, token]);

// Setup socket listeners
useEffect(() => {
if (user && token) {
// Connect socket
socketService.connect(token);
socketService.joinRoom(user._id, user.role);

// Listen for new notifications
socketService.on('new_notification', (data) => {
console.log('ðŸ“¬ New notification received:', data);

// Add to notifications list
setNotifications(prev => [data, ...prev]);
setUnreadCount(prev => prev + 1);

// Show toast with custom styling
toast.success(data.message, {
duration: 5000,
icon: 'ðŸ””',
style: {
borderRadius: '10px',
background: '#10B981',
color: '#fff',
},
});
});

// Listen for donation matched
socketService.on('donation_matched', (data) => {
console.log('âœ… Donation matched:', data);
toast.success('New donation matched to your organization!');
});

// Listen for donation accepted
socketService.on('donation_accepted', (data) => {
console.log('âœ… Donation accepted:', data);
toast.success('Your donation has been accepted!');
});

// Listen for volunteer assigned
socketService.on('volunteer_assigned', (data) => {
console.log('ðŸš— Volunteer assigned:', data);
toast.success(`Volunteer ${data.volunteer.name} assigned for pickup!`);
});

// Listen for status updates
socketService.on('status_updated', (data) => {
console.log('ðŸ”„ Status updated:', data);
const statusMessages = {
'picked_up': 'ðŸ“¦ Food picked up by volunteer',
'in_transit': 'ðŸš— Food in transit to NGO',
'delivered': 'âœ… Food delivered successfully!',
};
if (statusMessages[data.newStatus]) {
toast.success(statusMessages[data.newStatus]);
}
});

// Listen for delivery completed
socketService.on('delivery_completed', (data) => {
console.log('ðŸŽ‰ Delivery completed:', data);
toast.success('Delivery completed! Please rate the NGO.');
});

return () => {
socketService.disconnect();
};
}
}, [user, token]);

const fetchNotifications = async () => {
try {
const response = await api.get('/notifications?limit=50');
setNotifications(response.data.notifications);
setUnreadCount(response.data.unreadCount);
} catch (error) {
console.error('Error fetching notifications:', error);
}
};

const markAsRead = async (notificationId) => {
try {
await api.put(`/notifications/${notificationId}/read`);
setNotifications(prev =>
prev.map(notif =>
notif._id === notificationId ? { ...notif, isRead: true } : notif
)
);
setUnreadCount(prev => Math.max(0, prev - 1));
} catch (error) {
console.error('Error marking notification as read:', error);
}
};

const markAllAsRead = async () => {
try {
await api.put('/notifications/mark-all-read');
setNotifications(prev =>
prev.map(notif => ({ ...notif, isRead: true }))
);
setUnreadCount(0);
} catch (error) {
console.error('Error marking all as read:', error);
}
};

return (
<NotificationContext.Provider
value={{
notifications,
unreadCount,
markAsRead,
markAllAsRead,
refreshNotifications: fetchNotifications
}}
>
{children}
</NotificationContext.Provider>
);
};

export const useNotifications = () => {
const context = useContext(NotificationContext);
if (!context) {
throw new Error('useNotifications must be used within NotificationProvider');
}
return context;
};


ENHANCEMENT 3: Volunteer Assignment & Live Tracking System
Problem:
When NGO accepts a donation, nearby volunteers aren't notified and there's no live tracking of volunteer location.

Solution:
Step 1: Create Volunteer Assignment Logic

// backend/src/services/volunteerAssignmentService.js
// CREATE THIS NEW FILE

const User = require('../models/User');
const VolunteerTask = require('../models/VolunteerTask');
const Donation = require('../models/Donation');
const notificationService = require('./notificationService');

// Find and assign nearest available volunteer
exports.assignVolunteerToDonation = async (donation) => {
try {
console.log(`ðŸ” Finding volunteer for donation ${donation.donationId}`);

const pickupLocation = donation.location.coordinates.coordinates;
const deliveryLocation = donation.matchedNGO.ngoProfile.address.coordinates.coordinates;

// Find available volunteers within 20km radius
const availableVolunteers = await User.find({
role: 'volunteer',
isVerified: true,
isActive: true,
'volunteerProfile.currentLocation': {
$nearSphere: {
$geometry: {
type: 'Point',
coordinates: pickupLocation
},
$maxDistance: 20000 // 20km in meters
}
}
}).limit(10);

if (availableVolunteers.length === 0) {
console.log('âŒ No available volunteers found');
return null;
}

// Check if volunteer has active tasks
const volunteersWithoutActiveTasks = [];
for (const volunteer of availableVolunteers) {
const activeTasks = await VolunteerTask.countDocuments({
volunteer: volunteer._id,
status: { $in: ['assigned', 'accepted', 'picked_up', 'in_transit'] }
});

if (activeTasks === 0) {
volunteersWithoutActiveTasks.push(volunteer);
}
}

if (volunteersWithoutActiveTasks.length === 0) {
console.log('âŒ All nearby volunteers are busy');
return null;
}

// Select the closest available volunteer
const selectedVolunteer = volunteersWithoutActiveTasks[0];

// Calculate distance and estimated time
const distance = calculateDistance(pickupLocation, selectedVolunteer.volunteerProfile.currentLocation.coordinates);
const estimatedTime = Math.ceil(distance / 0.5); // Assuming 30 km/h average speed

// Create volunteer task
const task = await VolunteerTask.create({
taskId: `VT-${Date.now()}`,
donation: donation._id,
volunteer: selectedVolunteer._id,
donor: donation.donor,
ngo: donation.matchedNGO._id,
pickupLocation: {
name: donation.donor.donorProfile.businessName,
address: donation.location.address,
coordinates: {
type: 'Point',
coordinates: pickupLocation
},
contactPhone: donation.donor.phone
},
deliveryLocation: {
name: donation.matchedNGO.ngoProfile.organizationName,
address: donation.matchedNGO.ngoProfile.address,
coordinates: {
type: 'Point',
coordinates: deliveryLocation
},
contactPhone: donation.matchedNGO.phone
},
distance,
estimatedTime,
status: 'assigned',
timeline: [{
status: 'assigned',
timestamp: new Date(),
note: `Assigned to ${selectedVolunteer.fullName}`
}]
});

// Update donation
donation.assignedVolunteer = selectedVolunteer._id;
donation.assignedAt = new Date();
donation.timeline.push({
status: 'volunteer_assigned',
timestamp: new Date(),
updatedBy: selectedVolunteer._id,
note: `Volunteer ${selectedVolunteer.fullName} assigned`
});
await donation.save();

// Send notifications to all parties
await notificationService.createNotification({
recipient: selectedVolunteer._id,
type: 'volunteer_assigned',
title: 'New Delivery Task Assigned!',
message: `You have been assigned to pick up food from ${donation.donor.donorProfile.businessName}`,
relatedDonation: donation._id,
relatedTask: task._id,
priority: 'high'
});

await notificationService.createNotification({
recipient: donation.donor,
type: 'volunteer_assigned',
title: 'Volunteer Assigned',
message: `${selectedVolunteer.fullName} will pick up your donation soon`,
relatedDonation: donation._id,
priority: 'medium'
});

await notificationService.createNotification({
recipient: donation.matchedNGO._id,
type: 'volunteer_assigned',
title: 'Volunteer On The Way',
message: `${selectedVolunteer.fullName} is coming to deliver the food`,
relatedDonation: donation._id,
priority: 'medium'
});

// Emit socket events
global.io.to(selectedVolunteer._id.toString()).emit('volunteer_assigned', {
taskId: task._id,
donation: donation,
estimatedTime,
distance
});

global.io.to(donation.donor.toString()).emit('volunteer_assigned', {
donationId: donation._id,
volunteer: {
id: selectedVolunteer._id,
name: selectedVolunteer.fullName,
phone: selectedVolunteer.phone
},
eta: estimatedTime
});

global.io.to(donation.matchedNGO._id.toString()).emit('volunteer_assigned', {
donationId: donation._id,
volunteer: {
id: selectedVolunteer._id,
name: selectedVolunteer.fullName,
phone: selectedVolunteer.phone
},
eta: estimatedTime
});

console.log(`âœ… Volunteer ${selectedVolunteer.fullName} assigned to donation ${donation.donationId}`);

return task;
} catch (error) {
console.error('Error assigning volunteer:', error);
return null;
}
};

// Haversine formula for distance calculation
function calculateDistance(coord1, coord2) {
const [lon1, lat1] = coord1;
const [lon2, lat2] = coord2;

const R = 6371; // Earth's radius in km
const dLat = toRad(lat2 - lat1);
const dLon = toRad(lon2 - lon1);

const a =
Math.sin(dLat / 2) * Math.sin(dLat / 2) +
Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
Math.sin(dLon / 2) * Math.sin(dLon / 2);

const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
const distance = R * c;

return distance;
}

function toRad(degrees) {
return degrees * (Math.PI / 180);
}

module.exports = exports;

Step 2: Trigger Volunteer Assignment When NGO Accepts

// backend/src/controllers/ngoController.js
// MODIFY the acceptDonation function

const volunteerAssignmentService = require('../services/volunteerAssignmentService');

exports.acceptDonation = async (req, res) => {
try {
const { id } = req.params;

const donation = await Donation.findById(id)
.populate('donor matchedNGO');

if (!donation) {
return res.status(404).json({ success: false, message: 'Donation not found' });
}

// ... existing validation code ...

// Update donation status
donation.status = 'accepted';
donation.acceptedAt = new Date();
donation.timeline.push({
status: 'accepted',
timestamp: new Date(),
updatedBy: req.user._id,
note: 'Donation accepted by NGO'
});
await donation.save();

// NOTIFY DONOR
await notificationService.createNotification({
recipient: donation.donor._id,
type: 'donation_accepted',
title: 'Donation Accepted!',
message: `${req.user.ngoProfile.organizationName} has accepted your donation`,
relatedDonation: donation._id
});

global.io.to(donation.donor._id.toString()).emit('donation_accepted', {
donationId: donation._id,
ngo: {
id: req.user._id,
name: req.user.ngoProfile.organizationName
},
timestamp: new Date()
});

// **NEW: ASSIGN VOLUNTEER AUTOMATICALLY**
setTimeout(async () => {
const task = await volunteerAssignmentService.assignVolunteerToDonation(donation);
if (!task) {
console.log('âš ï¸ Could not assign volunteer automatically');
}
}, 2000); // Wait 2 seconds before assigning

res.json({
success: true,
message: 'Donation accepted successfully',
donation
});
} catch (error) {
console.error('Accept donation error:', error);
res.status(500).json({ success: false, message: 'Server error' });
}
};Step 3: Create Live Tracking Map Component

// frontend/src/components/volunteer/LiveTrackingMap.jsx
// CREATE THIS NEW FILE

import React, { useState, useEffect } from 'react';
import { MapContainer, TileLayer, Marker, Popup, Polyline, Circle } from 'react-leaflet';
import { motion } from 'framer-motion';
import { Navigation, Phone, MapPin, Clock, Package } from 'lucide-react';
import L from 'leaflet';
import socketService from '../../services/socketService';

// Custom marker icons
const createIcon = (color, type) => {
const iconHtml = type === 'volunteer'
? `<div style="background: ${color}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-center;">
<svg width="16" height="16" fill="white" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
</div>`
: `<div style="background: ${color}; width: 40px; height: 40px; border-radius: 8px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-center;">
<svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>
</div>`;

return L.divIcon({
html: iconHtml,
className: '',
iconSize: [30, 30],
iconAnchor: [15, 15]
});
};

const LiveTrackingMap = ({ task }) => {
const [volunteerLocation, setVolunteerLocation] = useState(null);
const [eta, setEta] = useState(task.estimatedTime);
const [route, setRoute] = useState([]);

const pickupCoords = [
task.pickupLocation.coordinates.coordinates[1],
task.pickupLocation.coordinates.coordinates[0]
];

const deliveryCoords = [
task.deliveryLocation.coordinates.coordinates[1],
task.deliveryLocation.coordinates.coordinates[0]
];

// Listen for volunteer location updates via socket
useEffect(() => {
socket

Service.on('volunteer_location', (data) => {
if (data.taskId === task._id) {
console.log('ðŸ“ Volunteer location updated:', data);
setVolunteerLocation([data.coordinates[1], data.coordinates[0]]);
setEta(data.eta);
}
});

return () => {
socketService.off('volunteer_location');
};
}, [task._id]);

// Calculate simple route (straight line for now)
useEffect(() => {
if (volunteerLocation) {
// Route from volunteer to pickup (if not picked up yet)
if (task.status === 'accepted' || task.status === 'assigned') {
setRoute([volunteerLocation, pickupCoords]);
}
// Route from volunteer to delivery (if picked up)
else if (task.status === 'picked_up' || task.status === 'in_transit') {
setRoute([volunteerLocation, deliveryCoords]);
}
}
}, [volunteerLocation, task.status]);

// Get initial volunteer location
useEffect(() => {
if (task.volunteer?.volunteerProfile?.currentLocation) {
const coords = task.volunteer.volunteerProfile.currentLocation.coordinates;
setVolunteerLocation([coords[1], coords[0]]);
}
}, [task.volunteer]);

return (
<div className="relative h-[500px] rounded-xl overflow-hidden shadow-lg">
<MapContainer
center={pickupCoords}
zoom={13}
className="h-full w-full"
zoomControl={false}
>
<TileLayer
url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
attribution='&copy; OpenStreetMap contributors'
/>

{/* Pickup Location */}
<Marker
position={pickupCoords}
icon={createIcon('#EF4444', 'location')}
>
<Popup>
<div className="p-2">
<h4 className="font-bold text-sm">Pickup Location</h4>
<p className="text-xs">{task.pickupLocation.name}</p>
<p className="text-xs text-neutral-600">{task.pickupLocation.address.street}</p>
</div>
</Popup>
</Marker>

{/* Delivery Location */}
<Marker
position={deliveryCoords}
icon={createIcon('#10B981', 'location')}
>
<Popup>
<div className="p-2">
<h4 className="font-bold text-sm">Delivery Location</h4>
<p className="text-xs">{task.deliveryLocation.name}</p>
<p className="text-xs text-neutral-600">{task.deliveryLocation.address.street}</p>
</div>
</Popup>
</Marker>

{/* Volunteer Location (Live) */}
{volunteerLocation && (
<>
<Marker
position={volunteerLocation}
icon={createIcon('#3B82F6', 'volunteer')}
>
<Popup>
<div className="p-2">
<h4 className="font-bold text-sm">Volunteer Location</h4>
<p className="text-xs">{task.volunteer?.fullName}</p>
<p className="text-xs text-neutral-600">Live tracking</p>
</div>
</Popup>
</Marker>

{/* Accuracy circle */}
<Circle
center={volunteerLocation}
radius={50}
pathOptions={{ color: '#3B82F6', fillColor: '#3B82F6', fillOpacity: 0.2 }}
/>
</>
)}

{/* Route polyline */}
{route.length > 0 && (
<Polyline
positions={route}
pathOptions={{ color: '#3B82F6', weight: 4, dashArray: '10, 10' }}
/>
)}
</MapContainer>

{/* Overlay Info Panel */}
<motion.div
className="absolute top-4 left-4 right-4 bg-white rounded-lg shadow-xl p-4 z-[1000]"
initial={{ y: -100, opacity: 0 }}
animate={{ y: 0, opacity: 1 }}
transition={{ delay: 0.3 }}
>
<div className="grid grid-cols-3 gap-4 mb-3">
<div className="text-center">
<Clock className="w-5 h-5 mx-auto mb-1 text-primary-green" />
<p className="text-xs text-neutral-600">ETA</p>
<p className="text-lg font-bold">{eta} min</p>
</div>

<div className="text-center">
<MapPin className="w-5 h-5 mx-auto mb-1 text-accent-blue" />
<p className="text-xs text-neutral-600">Distance</p>
<p className="text-lg font-bold">{task.distance.toFixed(1)} km</p>
</div>

<div className="text-center">
<Package className="w-5 h-5 mx-auto mb-1 text-accent-orange" />
<p className="text-xs text-neutral-600">Status</p>
<p className="text-sm font-semibold capitalize">{task.status.replace('_', ' ')}</p>
</div>
</div>

<div className="flex gap-2">
<button
onClick={() => window.open(`tel:${task.volunteer?.phone}`)}
className="flex-1 px-3 py-2 bg-primary-green text-white rounded-lg text-sm font-medium hover:bg-primary-dark transition-colors flex items-center justify-center gap-2"
>
<Phone className="w-4 h-4" />
Call Volunteer
</button>

<button
onClick={() => {
const url = `https://www.google.com/maps/dir/?api=1&origin=${volunteerLocation?.[0]},${volunteerLocation?.[1]}&destination=${deliveryCoords[0]},${deliveryCoords[1]}`;
window.open(url, '_blank');
}}
className="px-3 py-2 bg-accent-blue text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors flex items-center justify-center gap-2"
>
<Navigation className="w-4 h-4" />
</button>
</div>
</motion.div>

{/* Live Indicator */}
<div className="absolute bottom-4 left-4 bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 z-[1000]">
<motion.div
className="w-2 h-2 bg-white rounded-full"
animate={{ scale: [1, 1.5, 1] }}
transition={{ duration: 1.5, repeat: Infinity }}
/>
LIVE TRACKING
</div>
</div>
);
};

export default LiveTrackingMap;

Step 4: Add Tracking to NGO Dashboard

// frontend/src/pages/NGODashboard.jsx
// ADD this import and component

import LiveTrackingMap from '../components/volunteer/LiveTrackingMap';

// In the accepted donations section, ADD:

{acceptedDonations.map(donation => (
<div key={donation._id} className="card p-6 mb-4">
{/* Existing donation info */}

{/* ADD: Live tracking if volunteer assigned and in transit */}
{donation.assignedVolunteer &&
['accepted', 'picked_up', 'in_transit'].includes(donation.status) && (
<div className="mt-4">
<h4 className="font-bold mb-3 flex items-center gap-2">
<MapPin className="w-5 h-5 text-primary-green" />
Live Tracking
</h4>
<LiveTrackingMap task={donation.volunteerTask} />
</div>
)}
</div>
))}


ENHANCEMENT 4: Mark as Delivered Functionality
Problem:
Volunteers cannot mark orders as delivered after completing delivery.

Solution:
Step 1: Add Mark as Delivered Button in Volunteer Dashboard

// frontend/src/components/volunteer/DeliveryConfirmationModal.jsx
// CREATE THIS NEW FILE

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Camera, CheckCircle, Upload } from 'lucide-react';
import Button from '../common/Button';
import toast from 'react-hot-toast';
import api from '../../services/api';

const DeliveryConfirmationModal = ({ task, onClose, onConfirm }) => {
const [deliveryPhoto, setDeliveryPhoto] = useState(null);
const [photoPreview, setPhotoPreview] = useState(null);
const [notes, setNotes] = useState('');
const [isSubmitting, setIsSubmitting] = useState(false);

const handlePhotoUpload = (e) => {
const file = e.target.files[0];
if (file) {
if (file.size > 5 * 1024 * 1024) {
toast.error('Photo size should be less than 5MB');
return;
}

setDeliveryPhoto(file);

// Create preview
const reader = new FileReader();
reader.onloadend = () => {
setPhotoPreview(reader.result);
};
reader.readAsDataURL(file);
}
};

const handleSubmit = async () => {
if (!deliveryPhoto) {
toast.error('Please upload a delivery photo');
return;
}

setIsSubmitting(true);

try {
// Upload photo first
const formData = new FormData();
formData.append('image', deliveryPhoto);

const uploadResponse = await api.post('/upload/image', formData, {
headers: { 'Content-Type': 'multipart/form-data' }
});

// Update task status
await api.put(`/volunteer/tasks/${task._id}/status`, {
status: 'delivered',
note: notes,
photo: uploadResponse.data.imageUrl
});

toast.success('Delivery confirmed successfully!');
onConfirm();
onClose();
} catch (error) {
console.error('Error confirming delivery:', error);
toast.error(error.response?.data?.message || 'Failed to confirm delivery');
} finally {
setIsSubmitting(false);
}
};

return (
<AnimatePresence>
<motion.div
className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
initial={{ opacity: 0 }}
animate={{ opacity: 1 }}
exit={{ opacity: 0 }}
onClick={onClose}
>
<motion.div
className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl"
initial={{ scale: 0.9, y: 20 }}
animate={{ scale: 1, y: 0 }}
exit={{ scale: 0.9, y: 20 }}
onClick={(e) => e.stopPropagation()}
>
{/* Header */}
<div className="flex items-center justify-between mb-6">
<h2 className="text-2xl font-bold text-neutral-900">
Confirm Delivery
</h2>
<button
onClick={onClose}
className="p-2 hover:bg-neutral-100 rounded-full transition-colors"
>
<X className="w-5 h-5" />
</button>
</div>

{/* Content */}
<div className="space-y-4">
{/* Photo Upload */}
<div>
<label className="block text-sm font-medium mb-2">
Delivery Photo *
</label>

{photoPreview ? (
<div className="relative">
<img
src={photoPreview}
alt="Delivery"
className="w-full h-48 object-cover rounded-lg"
/>
<button
onClick={() => {
setDeliveryPhoto(null);
setPhotoPreview(null);
}}
className="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors"
>
<X className="w-4 h-4" />
</button>
</div>
) : (
<label className="border-2 border-dashed border-neutral-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary-green transition-colors block">
<input
type="file"
accept="image/*"
capture="environment"
className="hidden"
onChange={handlePhotoUpload}
/>
<Camera className="w-12 h-12 mx-auto mb-3 text-neutral-400" />
<p className="text-sm text-neutral-600 mb-1">
Take a photo of the delivery
</p>
<p className="text-xs text-neutral-400">
PNG, JPG up to 5MB
</p>
</label>
)}
</div>

{/* Notes */}
<div>
<label className="block text-sm font-medium mb-2">
Additional Notes (Optional)
</label>
<textarea
className="w-full px-4 py-3 rounded-lg border border-neutral-200 focus:border-primary-green focus:ring-2 focus:ring-primary-light outline-none transition"
rows="3"
placeholder="Any special notes about the delivery..."
value={notes}
onChange={(e) => setNotes(e.target.value)}
maxLength="500"
/>
<p className="text-xs text-neutral-500 mt-1 text-right">
{notes.length}/500
</p>
</div>

{/* Delivery Details */}
<div className="bg-primary-light/30 rounded-lg p-4">
<h4 className="font-semibold mb-2">Delivery Details</h4>
<div className="space-y-1 text-sm">
<p><span className="text-neutral-600">To:</span> {task.deliveryLocation.name}</p>
<p><span className="text-neutral-600">Address:</span> {task.deliveryLocation.address.street}</p>
<p><span className="text-neutral-600">Food:</span> {task.donation?.foodDetails.name}</p>
</div>
</div>
</div>

{/* Actions */}
<div className="flex gap-3 mt-6">
<Button
variant="outline"
className="flex-1"
onClick={onClose}
disabled={isSubmitting}
>
Cancel
</Button>
<Button
variant="primary"
className="flex-1"
onClick={handleSubmit}
loading={isSubmitting}
disabled={!deliveryPhoto}
>
<CheckCircle className="w-5 h-5 mr-2" />
Confirm Delivery
</Button>
</div>
</motion.div>
</motion.div>
</AnimatePresence>
);
};

export default DeliveryConfirmationModal;

Step 2: Add Mark as Delivered Button to Active Task View

// frontend/src/pages/VolunteerDashboard.jsx
// MODIFY the active task section

import DeliveryConfirmationModal from '../components/volunteer/DeliveryConfirmationModal';

// Inside component:
const [showDeliveryModal, setShowDeliveryModal] = useState(false);

// In the active task section, ADD:

{activeTask && activeTask.status === 'in_transit' && (
<div className="mt-4">
<Button
variant="primary"
size="lg"
className="w-full"
onClick={() => setShowDeliveryModal(true)}
>
<CheckCircle className="w-5 h-5 mr-2" />
Mark as Delivered
</Button>
</div>
)}

{/* Delivery Confirmation Modal */}
{showDeliveryModal && (
<DeliveryConfirmationModal
task={activeTask}
onClose={() => setShowDeliveryModal(false)}
onConfirm={() => {
// Refresh active task
fetchActiveTask();
}}
/>
)}


ENHANCEMENT 5: Rating System After Delivery
Problem:
After delivery is completed, donors cannot rate the restaurant/NGO and feedback doesn't reflect on dashboard.

Solution:
Step 1: Create Rating Modal Component

// frontend/src/components/donor/RatingModal.jsx
// CREATE OR REPLACE this file completely

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Star, Send, Package, Award, CheckCircle, MessageCircle } from 'lucide-react';
import Button from '../common/Button';
import toast from 'react-hot-toast';
import api from '../../services/api';

const RatingModal = ({ donation, ngo, onClose, onSubmit }) => {
const [ratings, setRatings] = useState({
overall: 0,
foodQuality: 0,
packaging: 0,
accuracy: 0,
communication: 0
});
const [comment, setComment] = useState('');
const [isSubmitting, setIsSubmitting] = useState(false);

const ratingCategories = [
{ key: 'foodQuality', label: 'Food Quality', icon: Package, description: 'Was the food properly handled?' },
{ key: 'packaging', label: 'Packaging', icon: Award, description: 'Was it well packaged?' },
{ key: 'accuracy', label: 'Accuracy', icon: CheckCircle, description: 'Matched the description?' },
{ key: 'communication', label: 'Communication', icon: MessageCircle, description: 'Responsive and clear?' }
];

const handleRatingChange = (category, value) => {
setRatings(prev => ({ ...prev, [category]: value }));
};

const calculateOverallRating = () => {
const { foodQuality, packaging, accuracy, communication } = ratings;
const sum = foodQuality + packaging + accuracy + communication;
return sum > 0 ? (sum / 4).toFixed(1) : 0;
};

const handleSubmit = async () => {
const overall = parseFloat(calculateOverallRating());

if (overall === 0) {
toast.error('Please provide ratings for at least one category');
return;
}

setIsSubmitting(true);

try {
await api.post('/donor/ratings', {
donation: donation._id,
ngo: ngo._id,
rating: overall,
comment,
categories: {
foodQuality: ratings.foodQuality,
packaging: ratings.packaging,
accuracy: ratings.accuracy,
communication: ratings.communication
}
});

toast.success('Thank you for your feedback!');
onSubmit();
onClose();
} catch (error) {
console.error('Error submitting rating:', error);
toast.error(error.response?.data?.message || 'Failed to submit rating');
} finally {
setIsSubmitting(false);
}
};

const RatingStars = ({ value, onChange, size = 'md' }) => {
const sizeClasses = {
sm: 'w-6 h-6',
md: 'w-8 h-8',
lg: 'w-10 h-10'
};

return (
<div className="flex gap-1">
{[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((star) => (
<motion.button
key={star}
type="button"
onClick={() => onChange(star)}
className={`${sizeClasses[size]} transition-all`}
whileHover={{ scale: 1.1 }}
whileTap={{ scale: 0.9 }}
>
<Star
className={`w-full h-full ${
star <= value
? 'fill-yellow-400 text-yellow-400'
: 'text-neutral-300'
} transition-colors`}
/>
</motion.button>
))}
</div>
);
};

return (
<AnimatePresence>
<motion.div
className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
initial={{ opacity: 0 }}
animate={{ opacity: 1 }}
exit={{ opacity: 0 }}
onClick={onClose}
>
<motion.div
className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 shadow-2xl"
initial={{ scale: 0.9, y: 20 }}
animate={{ scale: 1, y: 0 }}
exit={{ scale: 0.9, y: 20 }}
onClick={(e) => e.stopPropagation()}
>
{/* Header */}
<div className="flex items-center justify-between mb-6">
<div>
<h2 className="text-2xl font-bold text-neutral-900">
Rate Your Experience
</h2>
<p className="text-sm text-neutral-600 mt-1">
Help us improve by rating your experience with {ngo.ngoProfile.organizationName}
</p>
</div>
<button
onClick={onClose}
className="p-2 hover:bg-neutral-100 rounded-full transition-colors flex-shrink-0"
>
<X className="w-5 h-5" />
</button>
</div>

{/* Overall Rating Display */}
<div className="bg-gradient-to-br from-primary-light to-primary-green/10 rounded-xl p-6 mb-6 text-center">
<p className="text-sm text-neutral-600 mb-2">Overall Rating</p>
<motion.div
className="text-5xl font-bold text-primary-green"
key={calculateOverallRating()}
initial={{ scale: 1.2, opacity: 0 }}
animate={{ scale: 1, opacity: 1 }}
>
{calculateOverallRating()}/10
</motion.div>
<div className="flex justify-center mt-3">
{[...Array(5)].map((_, i) => (
<Star
key={i}
className={`w-6 h-6 ${
i < Math.round(calculateOverallRating() / 2)
? 'fill-yellow-400 text-yellow-400'
: 'text-neutral-300'
}`}
/>
))}
</div>
</div>

{/* Rating Categories */}
<div className="space-y-6 mb-6">
{ratingCategories.map((category) => {
const Icon = category.icon;
return (
<div key={category.key} className="border-b border-neutral-100 pb-4 last:border-0">
<div className="flex items-start gap-3 mb-3">
<div className="w-10 h-10 bg-primary-light rounded-lg flex items-center justify-center flex-shrink-0">
<Icon className="w-5 h-5 text-primary-green" />
</div>
<div className="flex-1">
<h4 className="font-semibold text-neutral-900">{category.label}</h4>
<p className="text-sm text-neutral-600">{category.description}</p>
</div>
<div className="text-right flex-shrink-0">
<span className="text-2xl font-bold text-primary-green">
{ratings[category.key]}
</span>
<span className="text-neutral-500">/10</span>
</div>
</div>
<RatingStars
value={ratings[category.key]}
onChange={(value) => handleRatingChange(category.key, value)}
size="sm"
/>
</div>
);
})}
</div>

{/* Comment */}
<div className="mb-6">
<label className="block text-sm font-medium mb-2">
Additional Comments (Optional)
</label>
<textarea
className="w-full px-4 py-3 rounded-lg border border-neutral-200 focus:border-primary-green focus:ring-2 focus:ring-primary-light outline-none transition"
rows="4"
placeholder="Share your experience... What went well? What could be improved?"
value={comment}
onChange={(e) => setComment(e.target.value)}
maxLength="500"
/>
<p className="text-xs text-neutral-500 mt-1 text-right">
{comment.length}/500
</p>
</div>

{/* Donation Info */}
<div className="bg-neutral-50 rounded-lg p-4 mb-6">
<h4 className="font-semibold mb-2">Donation Details</h4>
<div className="grid grid-cols-2 gap-2 text-sm">
<p><span className="text-neutral-600">Food:</span> {donation.foodDetails.name}</p>
<p><span className="text-neutral-600">Quantity:</span> {donation.foodDetails.quantity} {donation.foodDetails.unit}</p>
<p><span className="text-neutral-600">NGO:</span> {ngo.ngoProfile.organizationName}</p>
<p><span className="text-neutral-600">Status:</span> <span className="text-green-600 font-medium">Delivered</span></p>
</div>
</div>

{/* Actions */}
<div className="flex gap-3">
<Button
variant="outline"
className="flex-1"
onClick={onClose}
disabled={isSubmitting}
>
Skip for Now
</Button>
<Button
variant="primary"
className="flex-1"
onClick={handleSubmit}
loading={isSubmitting}
disabled={calculateOverallRating() === '0.0'}
>
<Send className="w-5 h-5 mr-2" />
Submit Rating
</Button>
</div>
</motion.div>
</motion.div>
</AnimatePresence>
);
};

export default RatingModal;

Step 2: Trigger Rating Modal After Delivery

// frontend/src/pages/DonorDashboard.jsx
// ADD this logic

import RatingModal from '../components/donor/RatingModal';

// Inside component:
const [showRatingModal, setShowRatingModal] = useState(false);
const [selectedDonationForRating, setSelectedDonationForRating] = useState(null);

// Listen for delivery completed event
useEffect(() => {
socketService.on('delivery_completed', (data) => {
// Find the donation
const donation = donations.find(d => d._id === data.donationId);
if (donation && !donation.rated) {
// Show rating modal after 2 seconds
setTimeout(() => {
setSelectedDonationForRating(donation);
setShowRatingModal(true);
}, 2000);
}
});

return () => {
socketService.off('delivery_completed');
};
}, [donations]);

// In JSX, ADD: {showRatingModal && selectedDonationForRating && ( <RatingModal donation={selectedDonationForRating} ngo={selectedDonationForRating.matchedNGO} onClose={() => { setShowRatingModal(false); setSelectedDonationForRating(null); }} onSubmit={() => { // Refresh donations to update rated status fetchDonations(); }} /> )}


**Step 3: Update Backend to Calculate and Store Ratings**
```javascript
// backend/src/controllers/donorController.js
// ADD or UPDATE the ratings endpoint

exports.rateDonation = async (req, res) => {
try {
const { donation, ngo, rating, comment, categories } = req.body;

// Validate
if (!donation || !ngo || !rating) {
return res.status(400).json({
success: false,
message: 'Donation, NGO, and rating are required'
});
}

if (rating < 1 || rating > 10) {
return res.status(400).json({
success: false,
message: 'Rating must be between 1 and 10'
});
}

// Check if donation exists and belongs to user
const donationDoc = await Donation.findOne({
_id: donation,
donor: req.user._id,
status: 'delivered'
});

if (!donationDoc) {
return res.status(404).json({
success: false,
message: 'Donation not found or not yet delivered'
});
}

// Check if already rated
const existingRating = await Rating.findOne({
donation,
ratedBy: req.user._id
});

if (existingRating) {
return res.status(400).json({
success: false,
message: 'You have already rated this donation'
});
}

// Create rating
const newRating = await Rating.create({
donation,
ratedBy: req.user._id,
ratedTo: ngo,
ratedType: 'ngo',
rating,
comment,
categories
});

// Update NGO rating
const ngoUser = await User.findById(ngo);
const currentRating = ngoUser.ngoProfile.rating || 0;
const currentTotal = ngoUser.ngoProfile.totalRatings || 0;

const newTotal = currentTotal + 1;
const newAverage = ((currentRating * currentTotal) + rating) / newTotal;

// Update rating breakdown
const currentBreakdown = ngoUser.ngoProfile.ratingBreakdown || {
foodQuality: 0,
packaging: 0,
accuracy: 0,
communication: 0
};

ngoUser.ngoProfile.rating = newAverage;
ngoUser.ngoProfile.totalRatings = newTotal;
ngoUser.ngoProfile.ratingBreakdown = {
foodQuality: ((currentBreakdown.foodQuality * currentTotal) + categories.foodQuality) / newTotal,
packaging: ((currentBreakdown.packaging * currentTotal) + categories.packaging) / newTotal,
accuracy: ((currentBreakdown.accuracy * currentTotal) + categories.accuracy) / newTotal,
communication: ((currentBreakdown.communication * currentTotal) + categories.communication) / newTotal
};

await ngoUser.save();

// Mark donation as rated
donationDoc.rated = true;
await donationDoc.save();

// Send notification to NGO
await notificationService.createNotification({
recipient: ngo,
type: 'new_rating',
title: 'New Rating Received',
message: `You received a ${rating}/10 rating from ${req.user.donorProfile.businessName}`,
relatedDonation: donation
});

global.io.to(ngo.toString()).emit('new_notification', {
type: 'new_rating',
message: `New rating: ${rating}/10`,
donation: donationDoc
});

res.json({
success: true,
message: 'Rating submitted successfully',
rating: newRating
});
} catch (error) {
console.error('Rate donation error:', error);
res.status(500).json({ success: false, message: 'Server error' });
}
};


ENHANCEMENT 6: Real-Time Urgency Score Calculation
Problem:
Urgency score doesn't calculate in real-time as user fills the donation form.

Solution:
// frontend/src/components/donor/DonationUploadForm.jsx
// ADD this logic to existing form

import { useEffect } from 'react';
import { AlertCircle, Clock, TrendingUp } from 'lucide-react';

// Inside component, ADD:
const [urgencyData, setUrgencyData] = useState({
score: 0,
category: 'low',
shelfLifeHours: 0
});

// Calculate urgency whenever relevant fields change
useEffect(() => {
const category = watch('category');
const preparationTime = watch('preparationTime');
const expiryTime = watch('expiryTime');

if (category && preparationTime && expiryTime) {
calculateUrgency(category, new Date(preparationTime), new Date(expiryTime));
}
}, [watch('category'), watch('preparationTime'), watch('expiryTime')]);

const calculateUrgency = (category, prepTime, expTime) => {
// Calculate shelf life in hours
const now = new Date();
const shelfLifeMs = expTime - now;
const shelfLifeHours = Math.max(0, shelfLifeMs / (1000 * 60 * 60));

// Perishability scores
const perishabilityScores = {
'cooked_meals': 0.9,
'dairy': 0.8,
'bakery': 0.6,
'vegetables': 0.5,
'fruits': 0.5,
'packaged_food': 0.2,
'beverages': 0.3,
'other': 0.5
};

const perishability = perishabilityScores[category] || 0.5;

// Time urgency
let timeUrgency;
if (shelfLifeHours < 2) {
timeUrgency = 1.0; // Critical
} else if (shelfLifeHours < 4) {
timeUrgency = 0.8; // High
} else if (shelfLifeHours < 6) {
timeUrgency = 0.6; // Medium-high
} else if (shelfLifeHours < 12) {
timeUrgency = 0.4; // Medium
} else if (shelfLifeHours < 24) {
timeUrgency = 0.2; // Low
} else {
timeUrgency = 0.1; // Very low
}

// Calculate overall score
const score = (perishability * 0.6) + (timeUrgency * 0.4);

// Determine category
let urgencyCategory;
if (score >= 0.7) {
urgencyCategory = 'high';
} else if (score >= 0.4) {
urgencyCategory = 'medium';
} else {
urgencyCategory = 'low';
}

setUrgencyData({
score: (score * 10).toFixed(1), // Convert to 0-10 scale
category: urgencyCategory,
shelfLifeHours: shelfLifeHours.toFixed(1)
});
};

const getUrgencyColor = (category) => {
switch (category) {
case 'high':
return 'from-red-500 to-red-600';
case 'medium':
return 'from-orange-500 to-orange-600';
case 'low':
return 'from-green-500 to-green-600';
default:
return 'from-neutral-400 to-neutral-500';
}
};

const getUrgencyText = (category) => {
switch (category) {
case 'high':
return 'High Urgency - Needs immediate attention!';
case 'medium':
return 'Medium Urgency - Should be handled soon';
case 'low':
return 'Low Urgency - Can wait';
default:
return 'Fill all fields to calculate urgency';
}
};

// ADD this at the bottom of the form (before submit button):

{urgencyData.score > 0 && (
<motion.div
className={`bg-gradient-to-r ${getUrgencyColor(urgencyData.category)} rounded-xl p-6 text-white`}
initial={{ opacity: 0, y: 20 }}
animate={{ opacity: 1, y: 0 }}
key={urgencyData.score}
>
<div className="flex items-center justify-between mb-4">
<div>
<h3 className="text-lg font-bold mb-1">Urgency Score</h3>
<p className="text-white/90 text-sm">{getUrgencyText(urgencyData.category)}</p>
</div>
<motion.div
className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm"
animate={{ scale: urgencyData.category === 'high' ? [1, 1.1, 1] : 1 }}
transition={{ duration: 1, repeat: urgencyData.category === 'high' ? Infinity : 0 }}
>
<span className="text-3xl font-bold">{urgencyData.score}</span>
</motion.div>
</div>

<div className="grid grid-cols-3 gap-4">
<div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
<Clock className="w-5 h-5 mb-1" />
<p className="text-xs opacity-90">Shelf Life</p>
<p className="font-bold">{urgencyData.shelfLifeHours}hrs</p>
</div>

<div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
<TrendingUp className="w-5 h-5 mb-1" />
<p className="text-xs opacity-90">Priority</p>
<p className="font-bold capitalize">{urgencyData.category}</p>
</div>

<div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
<AlertCircle className="w-5 h-5 mb-1" />
<p className="text-xs opacity-90">Action</p>
<p className="font-bold text-xs">
{urgencyData.category === 'high' ? 'Urgent' :
urgencyData.category === 'medium' ? 'Soon' :
'Normal'}
</p>
</div>
</div>
</motion.div>
)}


ENHANCEMENT 7: Consistency & Polish
Final Touches:
Step 1: Ensure All Status Updates Emit Socket Events

// backend/src/controllers/volunteerController.js
// UPDATE the updateTaskStatus function

exports.updateTaskStatus = async (req, res) => {
try {
const { id } = req.params;
const { status, note, photo, location } = req.body;

const task = await VolunteerTask.findOne({
_id: id,
volunteer: req.user._id
}).populate('donation donor ngo');

if (!task) {
return res.status(404).json({ success: false, message: 'Task not found' });
}

// Update task status
task.status = status;
if (photo) task.photos.deliveryPhoto = photo;

task.timeline.push({
status,
timestamp: new Date(),
location: location ? { coordinates: location } : undefined,
note
});

// Update corresponding donation status
const donation = task.donation;

if (status === 'picked_up') {
donation.status = 'picked_up';
donation.pickupTime = new Date();
task.pickupTime = new Date();
} else if (status === 'in_transit') {
donation.status = 'in_transit';
} else if (status === 'delivered') {
donation.status = 'delivered';
donation.deliveryTime = new Date();
task.deliveryTime = new Date();
task.actualTime = Math.ceil((task.deliveryTime - task.createdAt) / 60000); // in minutes
}

donation.timeline.push({
status,
timestamp: new Date(),
updatedBy: req.user._id,
note
});

await task.save();
await donation.save();

// CREATE NOTIFICATIONS FOR ALL PARTIES
const statusMessages = {
'picked_up': 'Food picked up',
'in_transit': 'Food in transit',
'delivered': 'Food delivered'
};

// Notify donor
await notificationService.createNotification({
recipient: donation.donor._id,
type: 'status_updated',
title: 'Delivery Update',
message: `${statusMessages[status]} by ${req.user.fullName}`,
relatedDonation: donation._id
});

// Notify NGO
await notificationService.createNotification({
recipient: donation.matchedNGO._id,
type: 'status_updated',
title: 'Delivery Update',
message: `${statusMessages[status]} - ETA: ${task.estimatedTime} minutes`,
relatedDonation: donation._id
});

// EMIT SOCKET EVENTS TO ALL PARTIES
global.io.to(donation.donor._id.toString()).emit('status_updated', {
donationId: donation._id,
newStatus: status,
timestamp: new Date(),
volunteer: {
name: req.user.fullName,
phone: req.user.phone
}
});

global.io.to(donation.matchedNGO._id.toString()).emit('status_updated', {
donationId: donation._id,
newStatus: status,
timestamp: new Date(),
volunteer: {
name: req.user.fullName,
phone: req.user.phone
}
});

// If delivered, emit special event
if (status === 'delivered') {
global.io.to(donation.donor._id.toString()).emit('delivery_completed', {
donationId: donation._id,
taskId: task._id,
timestamp: new Date()
});
}

res.json({
success: true,
message: 'Task status updated',
task,
donation
});
} catch (error) {
console.error('Update task status error:', error);
res.status(500).json({ success: false, message: 'Server error' });
}
};

Step 2: Add Notification Sound File

// frontend/public/notification-sound.mp3
// ADD a notification sound file to the public folder
// You can use a free sound from: https://notificationsounds.com/
// Or create a simple beep sound

Step 3: Update Dashboard Stats to Include Ratings

// frontend/src/pages/DonorDashboard.jsx
// UPDATE stats cards to include rating info

<StatsCard
icon={Star}
label="Your Rating"
value={donorRating.toFixed(1)}
unit="/10"
change={`Based on ${totalRatings} ratings`}
color="yellow"
/>


ðŸŽ¯ Implementation Checklist
Before You Start:
[ ] Backup your entire project
[ ] Create a new git branch: git checkout -b enhancements
[ ] Make sure your current code is working
Implementation Order (DO NOT SKIP):
Enhancement 1: Restaurant Rating System (30 mins)

[ ] Update User model with rating fields
[ ] Create DonorRatingDisplay component
[ ] Add to NGO donation cards
[ ] Update API to include donor info
[ ] Test: Browse donations as NGO, verify ratings show
Enhancement 2: Notification System (45 mins)

[ ] Update NotificationBell component
[ ] Create NotificationDropdown component
[ ] Update NotificationContext with socket listeners
[ ] Add notification sound
[ ] Test: Accept donation, verify notification appears with sound
Enhancement 3: Volunteer Assignment & Tracking (60 mins)

[ ] Create volunteerAssignmentService
[ ] Update acceptDonation to trigger assignment
[ ] Create LiveTrackingMap component
[ ] Add to NGO dashboard
[ ] Test: Accept donation, verify volunteer assigned, map shows
Enhancement 4: Mark as Delivered (30 mins)

[ ] Create DeliveryConfirmationModal
[ ] Add button to volunteer dashboard
[ ] Update backend controller
[ ] Test: Mark delivery, verify photo upload works
Enhancement 5: Rating System (45 mins)

[ ] Create RatingModal component
[ ] Add to donor dashboard
[ ] Implement backend rating endpoint
[ ] Test: Complete delivery, rate NGO, verify score updates
Enhancement 6: Urgency Calculator (20 mins)

[ ] Add real-time calculation to upload form
[ ] Create urgency display card
[ ] Test: Fill form, verify score updates live
Enhancement 7: Consistency (30 mins)

[ ] Update all socket emissions
[ ] Add notification sound
[ ] Update dashboard stats
[ ] Test: Complete full flow from upload to delivery
After Implementation:
[ ] Test complete user flow: Donor â†’ NGO â†’ Volunteer â†’ Rating
[ ] Verify all notifications appear
[ ] Check live tracking works
[ ] Confirm ratings update correctly
[ ] Test on mobile responsive view
[ ] Check console for errors
[ ] Commit changes: git commit -m "Add enhancements"

ðŸš¨ IMPORTANT REMINDERS
DO NOT delete or rename existing code - Only add new code
Test each enhancement individually before moving to the next
If something breaks, revert that specific file and try again
Keep your backend running while testing
Clear browser cache if components don't update
Check browser console for errors after each change
Verify socket connection in Network tab (should show WS connection)

âœ… Success Criteria
Your enhancements are complete when:

âœ… Restaurants have ratings visible in NGO view
âœ… Notifications appear with sound when events happen
âœ… Volunteers are auto-assigned when NGO accepts
âœ… Live map tracking shows volunteer location
âœ… Volunteers can mark as delivered with photo
âœ… Rating modal appears after delivery
âœ… Ratings update donor dashboard
âœ… Urgency score calculates in real-time during upload
âœ… All features work without breaking existing functionality

Good luck with your enhancements! Make changes carefully and test thoroughly! ðŸš€


this is the prompt do the req chnages and then create accounts and some dontaions some aacccpeted some not to test the whole systemÂ 
